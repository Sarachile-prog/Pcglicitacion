rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * CORE PHILOSOPHY:
     * This ruleset implements a "Public Read, Admin Write" model. The application focuses on 
     * providing transparent access to scraped bid opportunities (Licitaciones). While data 
     * is readable by anyone (including anonymous users), modifications are strictly 
     * restricted to accounts verified as administrators.
     *
     * DATA STRUCTURE:
     * The data is organized into top-level, flat collections: /categories, /awardingBodies, 
     * and /bids. This flat structure ensures "Authorization Independence," where the 
     * permission to read a document is self-contained and does not require costly 
     * recursive lookups or parent-document checks.
     *
     * KEY SECURITY DECISIONS:
     * 1. Public Accessibility: All content entities (Bids, Categories, Awarding Bodies) are 
     *    publicly listable and readable to maximize searchability and reach.
     * 2. DBAC (Database Access Control): Administrative privileges are determined by the 
     *    presence of a user's UID in the '/roles_admin' collection.
     * 3. Relational Integrity: On creation and update, rules enforce that document IDs 
     *    within the data match the Firestore document path and remain immutable.
     * 4. Prototyping Flexibility: While authorization is strict, data schema validation 
     *    (types and optional fields) is omitted to allow for rapid iteration of the 
     *    scraping and AI summary logic.
     */

    // --- Helper Functions ---

    /** @description Checks if the request is from an authenticated user. */
    function isSignedIn() {
      return request.auth != null;
    }

    /** @description Checks if the authenticated user has administrative privileges via the roles_admin collection. */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /** @description Verifies document existence and admin status for state-changing operations. */
    function isExistingAdmin() {
      return isAdmin() && resource != null;
    }

    // --- Collection Rules ---

    /**
     * @description Rules for the 'Category' collection. Publicly readable classification for bids.
     * @path /categories/{categoryId}
     * @allow (get) Any user (including guest) can view a category.
     * @deny (create) Non-admin users cannot create new categories.
     * @principle Administrative control for taxonomies with public visibility.
     */
    match /categories/{categoryId} {
      allow get, list: if true;
      allow create: if isAdmin() && request.resource.data.id == categoryId;
      allow update: if isExistingAdmin() && request.resource.data.id == resource.data.id;
      allow delete: if isExistingAdmin();
    }

    /**
     * @description Rules for the 'AwardingBody' collection. Information about institutions issuing bids.
     * @path /awardingBodies/{awardingBodyId}
     * @allow (list) Any user can browse the list of awarding bodies.
     * @deny (update) Attempting to change an awarding body ID during update.
     * @principle Public context for bids with restricted management.
     */
    match /awardingBodies/{awardingBodyId} {
      allow get, list: if true;
      allow create: if isAdmin() && request.resource.data.id == awardingBodyId;
      allow update: if isExistingAdmin() && request.resource.data.id == resource.data.id;
      allow delete: if isExistingAdmin();
    }

    /**
     * @description Rules for the 'Bid' collection. The primary entity containing scraped opportunities.
     * @path /bids/{bidId}
     * @allow (get) Public access to specific bid details and GenAI summaries.
     * @deny (delete) Deletion of a bid by a standard authenticated user.
     * @principle Open data access for transparency; write protection for data integrity.
     */
    match /bids/{bidId} {
      allow get, list: if true;
      allow create: if isAdmin() && request.resource.data.id == bidId;
      allow update: if isExistingAdmin() && request.resource.data.id == resource.data.id;
      allow delete: if isExistingAdmin();
    }

    /**
     * @description Role-based access control collection. Presence of a UID document grants admin rights.
     * @path /roles_admin/{userId}
     * @allow (get) Authenticated users can check if their own UID is in the admin list.
     * @deny (list) Public users listing the names/IDs of all administrators.
     * @principle Secure segregation of administrative metadata.
     */
    match /roles_admin/{userId} {
      // Users can check their own admin status to update UI state
      allow get: if isSignedIn() && request.auth.uid == userId;
      // Only existing admins can see the full list of other admins
      allow list: if isAdmin();
      // Writing to this collection should ideally be done via Admin SDK/Console for safety
      allow create, update, delete: if false; 
    }
  }
}