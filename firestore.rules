rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * CORE PHILOSOPHY:
     * This ruleset implements a multi-tenant security model. 
     * 1. Public Read: Bids, categories, and awarding bodies are public.
     * 2. User Profiles: Users can manage their own data.
     * 3. Multi-tenancy: Company data (bookmarks, documents) is isolated by companyId.
     * 4. SuperAdmin: Absolute control for the master account.
     */

    // --- Helper Functions ---

    function isSignedIn() {
      return request.auth != null;
    }

    /** @description Identifies the master account via verified email token. */
    function isSuperAdmin() {
      return isSignedIn() && request.auth.token.email == 'control@pcgoperacion.com';
    }

    /** @description Checks for administrative privileges either via SuperAdmin email or roles_admin existence. */
    function isAdmin() {
      return isSuperAdmin() || (isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid)));
    }

    /** @description Checks if the user belongs to a specific company. */
    function belongsToCompany(companyId) {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
    }

    // --- Collection Rules ---

    /**
     * @description User profiles containing roles and company links.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      allow list: if isAdmin();
      allow create: if isSignedIn() && request.auth.uid == userId;
      // Users can update their own profile, but only admins can change roles or companyId
      allow update: if isSignedIn() && (
        request.auth.uid == userId || isAdmin()
      );
    }

    /**
     * @description Multi-tenant company data.
     */
    match /companies/{companyId} {
      allow get: if isSignedIn() && (belongsToCompany(companyId) || isAdmin());
      allow list: if isAdmin();
      allow create, update: if isAdmin();
      
      /**
       * @description Bids followed by a specific company and their team collaboration data.
       */
      match /bookmarks/{bidId} {
        allow read, write: if isAdmin() || belongsToCompany(companyId);
      }
    }

    /**
     * @description Global settings for API tickets and synchronization state.
     */
    match /settings/{settingId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /categories/{categoryId} {
      allow get, list: if true;
      allow create: if isAdmin() && request.resource.data.id == categoryId;
      allow update: if isAdmin() && request.resource.data.id == resource.data.id;
      allow delete: if isAdmin();
    }

    match /awardingBodies/{awardingBodyId} {
      allow get, list: if true;
      allow create: if isAdmin() && request.resource.data.id == awardingBodyId;
      allow update: if isAdmin() && request.resource.data.id == resource.data.id;
      allow delete: if isAdmin();
    }

    match /bids/{bidId} {
      allow get, list: if true;
      allow create: if isAdmin() && request.resource.data.id == bidId;
      allow update: if (isAdmin() || isSignedIn()) && request.resource.data.id == resource.data.id;
      allow delete: if isAdmin();
    }

    match /roles_admin/{userId} {
      allow get: if isSignedIn() && request.auth.uid == userId;
      allow list: if isAdmin();
      allow write: if false; 
    }

    /**
     * @description Cache for Mercado Publico API responses to avoid rate limits.
     */
    match /mp_cache/{cacheId} {
      allow read: if true;
      allow write: if isSignedIn();
    }
  }
}